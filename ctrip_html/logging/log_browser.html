<!DOCTYPE html>
<html>
<head>

<title>LogBrowser设计文档 </title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<script type="text/javascript" src="../js/jquery-1.6.4.min.js"></script>

<link rel="Stylesheet" type="text/css" href="../js/sh/styles/shCore.css">
<link rel="Stylesheet" type="text/css" href="../js/sh/styles/shThemeRDark.css">
<script type="text/javascript" src="../js/sh/scripts/shCore.js"></script>
<script type="text/javascript" src="../js/sh/scripts/shAutoloader.js"></script>

<script type="text/javascript" src="../js/main.js"></script>

<link rel="Stylesheet" type="text/css" href="../style.css">
<link rel="Stylesheet" type="text/css" href="../css/main.css">

</head>
<body>
	<div class="hidden">
		<input id="root_path" type="text" value="../">
	</div>
	<div id="body-wrapper">
		<div id="container">
			<div id="top">
				<div id="page-title">
					<a href="../index.html">CTRIP</a>
				</div>
				<ul id="top-nav">
				</ul>
			</div>
			<div id="middle">
				

<h1 id="toc_1"> LogBrowser设计文档</h1>

<div class="toc">
<ul>
<li><a href="#toc_1"> LogBrowser设计文档</a>
<ul>
<li><a href="#toc_1.1">1 概述</a>
<li><a href="#toc_1.2">2 设计目标</a>
<li><a href="#toc_1.3">3 总体架构</a>
<ul>
<li><a href="#toc_1.3.1">3.1 数据源 </a>
<li><a href="#toc_1.3.2">3.2 Restful Api</a>
<li><a href="#toc_1.3.3">3.3 web应用</a>
</ul>
<li><a href="#toc_1.4">4 程序结构</a>
<li><a href="#toc_1.5">5 领域模型</a>
<ul>
<li><a href="#toc_1.5.1">5.1 元数据 </a>
<ul>
<li><a href="#toc_1.5.1.1">5.1.1 成员及关系 </a>
<li><a href="#toc_1.5.1.2">5.1.2 实体组成</a>
<li><a href="#toc_1.5.1.3">5.1.3 数据来源</a>
</ul>
<li><a href="#toc_1.5.2">5.2 配置数据</a>
<ul>
<li><a href="#toc_1.5.2.1">5.2.1 Agent配置</a>
</ul>
<li><a href="#toc_1.5.3">5.3 日志数据</a>
</ul>
<li><a href="#toc_1.6">6 Restful Api 接口</a>
<li><a href="#toc_1.7">7 Log-Browser日志应用</a>
<li><a href="#toc_1.8">8 其他模块关联更改</a>
<ul>
<li><a href="#toc_1.8.1">8.1 HBase Scheme更新</a>
<ul>
<li><a href="#toc_1.8.1.1">8.1.1 HBase Log Scheme优化</a>
<li><a href="#toc_1.8.1.2">8.1.2 HBase Log 统计 Scheme</a>
</ul>
<li><a href="#toc_1.8.2">8.2 HBase Writer 日志统计模块</a>
</ul>
<li><a href="#toc_1.9">9 部署架构</a>
</ul>
</ul>
</div>

<h2 id="toc_1.1">1 概述</h2>
<p>
Logging 2.0上线，公司内越来越多的应用接入，各应用部门对及时快速准确获得相应日志的需求越来越高，也越来越多样化。 
目前我们已经提供了日志查询的应用LogView和日志转存功能。但还不能真正满足用户的需求。
</p>

<p>
为了提供给用户更好的服务与用户体验，现开启了这个新项目LogBrowser，提供给用户以直觉导航浏览式的方式查看日志。
</p>

<p>
当前Logging2.0自身的应用，数量已超过6个，主要有LogView TraceView，而且全都基于开源项目，架构也不统一，难以扩展与维护,
浪费了大量的人力资源，而且不能带来令人满意的回报。
接下来的目标就是将这些应用慢慢整合，最终合并成两个应用，一个用于提供数据的RestfulApi, 一个用于提供Web界面操作的LogBrowser.
接下来以这个项目为契机，开启这种进化。
</p>

<p>
Logging2.0当前后端的HBase设计也存在一定的问题，在查询速度与并发访问下表现并不能使人满意，存在大量浪费带宽的行为。
在此次项目开发中，也会使用新方案，改善这种情况。
</p>

<h2 id="toc_1.2">2 设计目标</h2>
<ul>
<li>
<strong>提供一个可扩展的应用基础架构</strong>

<ol>
<li>
当前的应用会慢慢合并到LogBrowser中

<li>
以后新开发的应用在LogBrowser中扩展

</ol>
<li>
<strong>数据服务分离</strong>

<ol>
<li>
开发Restful Api提供专门的数据服务

<li>
LogBrowser只提供界面服务，通过Ajax与Restful Api通信，获取相应数据

</ol>
</ul>

<h2 id="toc_1.3">3 总体架构</h2>

<p>
<img src="log-browser.png" />
</p>

<p>
总体架构如上，分为三种角色: <strong>数据源 </strong> 、 <strong>Restful Api接口</strong> 、 <strong>web应用</strong>
</p>

<h3 id="toc_1.3.1">3.1 数据源 </h3>
<p>
数据源分为两种，HBase和MySql.
</p>

<p>
<strong>HBase:</strong>
</p>
<ul>
<li>
用于存储海量的日志数据，主要包含四种结构化数据：log, span, metric, event

<li>
HBase里的数据主要是通过HBaseWriter写进来的

</ul>

<p>
<strong>MySql:</strong>
</p>
<ul>
<li>
MySql里主要用于存储Central Logging 2.0的辅助数据，比如元数据等。

<ol>
<li>
关于App的元数据（appId, department, server etc.)

<li>
配置数据（日志的配置信息，metric namespace的配置信息）

</ol>
<li>
MySql中的数据来源有两种：第三方系统和通过 api 录入的

<ol>
<li>
第三方来源：app相关的元数据

<li>
api录入:配置信息

</ol>
</ul>

<h3 id="toc_1.3.2">3.2 Restful Api</h3>
<ul>
<li>
以上面两种数据源为基础，包装并暴露合理的api接口，提供数据服务

<li>
设计restful api分为三类

<ol>
<li>
Meta Api.  <code>logging/apps</code> 获取所有的app列表

<li>
Config Api. <code>logging/config/agent-configs</code> 获取agent的日志配置

<li>
Data Api. <code>logging/data/logs?app=110101&amp;startDate=2013-01-01 18:00:00</code> 获取某个app指定时间段的日志数据 

</ol>
<li>
restful api可以返回两种数据：xml json

</ul>

<h3 id="toc_1.3.3">3.3 web应用</h3>
<ul>
<li>
Log-Browser应用

<li>
以导航式方式查看日志数据

<li>
根据用户的点击导航，从restful api获取数据，以友好美观的方式呈现给用户

</ul>

<h2 id="toc_1.4">4 程序结构</h2>
<p>
当前Central-Logging 2.0的组成：
</p>

<p>
<img src="central-logging-project.png" />
</p>

<p>
Central-Logging 2.0中Log-Browser相关的将划分为三个子项目，挂在Central-Logging 2.0下面。
</p>
<ul>
<li>
<strong>central-logging-domain:</strong> 

<ol>
<li>
用于定义领域模型对应的java bean和相关信息，作为jar包被其他子项目依赖。

<li>
基包: <code>com.ctrip.freeway.domain</code>

</ol>
<li>
<strong>central-logging-restful:</strong>

<ol>
<li>
用于开发Restful Api接口，将作为一个web 项目发布

<li>
基包: <code>com.ctrip.framework.freeway.rest</code>

</ol>
<li>
<strong>central-logging-web:</strong>

<ol>
<li>
用户直接使用的产品，提供界面，作为web 项目发布。

<li>
基包: <code>com.ctrip.framework.freeway.web</code>

</ol>
</ul>

<h2 id="toc_1.5">5 领域模型</h2>
<p>
Central Logging 2.0中的数据模型分为三类:meta data(<strong>元数据 </strong>), configration data(<strong>配置数据</strong>), log data(<strong>日志数据</strong>: log metric span event).
这些领域模型对应的Java Bean在项目central-loggging-domain里定义
</p>

<h3 id="toc_1.5.1">5.1 元数据 </h3>
<h4 id="toc_1.5.1.1">5.1.1 成员及关系 </h4>
<p>
<img src="domain-meta.png" />
</p>

<p>
元数据的领域模型主要是以App为核心展开的：
</p>
<ul>
<li>
<strong>Department:</strong> 代表携程的一个部门， 一层结构。一个部门下可以有多个应用

<li>
<strong>App:</strong> 代表一个具体的应用。和Department的关系是多对一。

<li>
<strong>AppServer:</strong> 代表运营环境中一台具体的服务器。服务器上可以运行一个具体的应用。

<ul>
<li>
上图中和App的关系是多个一，实际上可能是多对多，因为一台服务器上可以运行多个App.

</ul>
<li>
<strong>AppService:</strong> 代表一个被trace的服务，比如一个具体的WebService接口。和App的关系是多对一。

<li>
<strong>ServiceSpan:</strong> 代表服务中的一个方法。比如某个WebService接口中的一个方法。

</ul>

<p>
<strong>总结:</strong> 一个部门下可以有多个应用;一个应用可以有多台服务器;一个应用可以多个服务;一个服务可以有多个方法
</p>


<h4 id="toc_1.5.1.2">5.1.2 实体组成</h4>
<p>
<img src="domain-meta-entity.png" />
</p>

<p>
<strong>Department:</strong>
<table>
<tr>
<th>
属性 
</th>
<th>
类型
</th>
<th>
说明
</th>
</tr>
<tr>
<td>
name
</td>
<td>
String
</td>
<td>
部门名称
</td>
</tr>
<tr>
<td>
description
</td>
<td>
String
</td>
<td>
部门描述
</td>
</tr>
</table>
</p>

<p>
<strong>App:</strong>
<table>
<tr>
<th>
属性 
</th>
<th>
类型
</th>
<th>
说明
</th>
</tr>
<tr>
<td>
appId
</td>
<td>
String
</td>
<td>
公司分配给这个应用的一个应用号，通常为6位数字 
</td>
</tr>
<tr>
<td>
name
</td>
<td>
String
</td>
<td>
应用名称
</td>
</tr>
<tr>
<td>
description
</td>
<td>
String
</td>
<td>
应用描述
</td>
</tr>
<tr>
<td>
appServers
</td>
<td>
List&lt;AppServer&gt;
</td>
<td>
应用拥有的服务器列表
</td>
</tr>
<tr>
<td>
appServices
</td>
<td>
List&lt;AppService&gt;
</td>
<td>
应用中被trace的服务列表 
</td>
</tr>
</table>
</p>

<p>
<strong>AppServer:</strong>
<table>
<tr>
<th>
属性 
</th>
<th>
类型
</th>
<th>
说明
</th>
</tr>
<tr>
<td>
hostName
</td>
<td>
String
</td>
<td>
服务器的hostName
</td>
</tr>
<tr>
<td>
ip
</td>
<td>
String
</td>
<td>
服务器的ip
</td>
</tr>
</table>
</p>

<p>
<strong>AppService:</strong>
<table>
<tr>
<th>
属性 
</th>
<th>
类型
</th>
<th>
说明
</th>
</tr>
<tr>
<td>
name
</td>
<td>
String
</td>
<td>
service名称
</td>
</tr>
<tr>
<td>
serviceSpans
</td>
<td>
List&lt;ServiceSpan&gt;
</td>
<td>
服务所拥有的方法列表 
</td>
</tr>
</table>
</p>

<p>
<strong>ServiceSpan:</strong>
<table>
<tr>
<th>
属性 
</th>
<th>
类型
</th>
<th>
说明
</th>
</tr>
<tr>
<td>
name
</td>
<td>
String
</td>
<td>
方法名称
</td>
</tr>
</table>
</p>


<h4 id="toc_1.5.1.3">5.1.3 数据来源</h4>
<p>
无数数据的来源分为两种：
</p>
<ul>
<li>
Department App AppServer来自系统部的api, 我们定期更新

<li>
AppService ServiceSpan是由我们的HBaseWriter收集的，通过Restful Api更新

</ul>

<h3 id="toc_1.5.2">5.2 配置数据</h3>
<p>
配置数据分为两类，一类是对Agent的配置信息，一类是对Metric Namespace的配置信息。
</p>

<h4 id="toc_1.5.2.1">5.2.1 Agent配置</h4>
<p>
由类AgentConfig表示
</p>

<p>
<img src="domain-agent-config.png" />
</p>

<p>
<strong>AgentConfig:</strong>
<table>
<tr>
<th>
属性 
</th>
<th>
类型
</th>
<th>
说明
</th>
</tr>
<tr>
<td>
key
</td>
<td>
String
</td>
<td>
指定的一个Key,将确定对谁生效。通常为一个appId或server ip, 特殊key:"global",代表agent的默认配置 
</td>
</tr>
<tr>
<td>
appLogEnabled
</td>
<td>
boolean
</td>
<td>
表明是否开启日志 
</td>
</tr>
<tr>
<td>
traceEnabled
</td>
<td>
boolean
</td>
<td>
表明是否开启trace
</td>
</tr>
<tr>
<td>
metricEnabled
</td>
<td>
boolean
</td>
<td>
表明是否开启metrics
</td>
</tr>
<tr>
<td>
appLogLevel
</td>
<td>
LogLevel
</td>
<td>
日志级别，前提需要开启appLogEnabled
</td>
</tr>
<tr>
<td>
traceLogLevel
</td>
<td>
LogLevel
</td>
<td>
trace中的日志级别，前提需要开启traceLogEnabled
</td>
</tr>
<tr>
<td>
flushPeriod
</td>
<td>
int
</td>
<td>
毫秒，agent中打包chunk的频率 
</td>
</tr>
<tr>
<td>
maxMessageSize
</td>
<td>
int
</td>
<td>
KB，一条 log中message的最大size
</td>
</tr>
<tr>
<td>
urlLogSampleRate
</td>
<td>
double
</td>
<td>
url trace的采样率
</td>
</tr>
</table>
</p>

<h3 id="toc_1.5.3">5.3 日志数据</h3>

<h2 id="toc_1.6">6 Restful Api 接口</h2>

<h2 id="toc_1.7">7 Log-Browser日志应用</h2>

<h2 id="toc_1.8">8 其他模块关联更改</h2>

<h3 id="toc_1.8.1">8.1 HBase Scheme更新</h3>
<h4 id="toc_1.8.1.1">8.1.1 HBase Log Scheme优化</h4>
<h4 id="toc_1.8.1.2">8.1.2 HBase Log 统计 Scheme</h4>

<h3 id="toc_1.8.2">8.2 HBase Writer 日志统计模块</h3>

<h2 id="toc_1.9">9 部署架构</h2>

			</div>

			<div id="bottom">
				&copy; 2012 王兴朝
			</div>
		</div>
	<div>
</body>
</html>
