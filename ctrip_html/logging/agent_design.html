<!DOCTYPE html>
<html>
<head>

<title>Agent Design and Implementation</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<script type="text/javascript" src="../js/jquery-1.6.4.min.js"></script>

<link rel="Stylesheet" type="text/css" href="../js/sh/styles/shCore.css">
<link rel="Stylesheet" type="text/css" href="../js/sh/styles/shThemeRDark.css">
<script type="text/javascript" src="../js/sh/scripts/shCore.js"></script>
<script type="text/javascript" src="../js/sh/scripts/shAutoloader.js"></script>

<script type="text/javascript" src="../js/main.js"></script>

<link rel="Stylesheet" type="text/css" href="../style.css">
<link rel="Stylesheet" type="text/css" href="../css/main.css">

</head>
<body>
	<div class="hidden">
		<input id="root_path" type="text" value="../">
	</div>
	<div id="body-wrapper">
		<div id="container">
			<div id="top">
				<div id="page-title">
					<a href="../index.html">CTRIP</a>
				</div>
				<ul id="top-nav">
				</ul>
			</div>
			<div id="middle">
				
<h1 id="toc_1">Agent Design and Implementation</h1>

<div class="toc">
<ul>
<li><a href="#toc_1">Agent Design and Implementation</a>
<ul>
<li><a href="#toc_1.1">Agent总体设计</a>
<ul>
<li><a href="#toc_1.1.1">功能目标</a>
<li><a href="#toc_1.1.2">配置信息</a>
<li><a href="#toc_1.1.3">数据流 </a>
</ul>
<li><a href="#toc_1.2">结构化数据 </a>
<li><a href="#toc_1.3">Agent数据采集</a>
<ul>
<li><a href="#toc_1.3.1">采集Log</a>
<ul>
<li><a href="#toc_1.3.1.1">核心类 </a>
<li><a href="#toc_1.3.1.2">FreewayLogger</a>
<li><a href="#toc_1.3.1.3">FreewayLoggerSender</a>
</ul>
<li><a href="#toc_1.3.2">采集Trace</a>
<li><a href="#toc_1.3.3">采集Metrics</a>
<ul>
<li><a href="#toc_1.3.3.1">核心类 </a>
<li><a href="#toc_1.3.3.2">IMetricImpl</a>
</ul>
</ul>
<li><a href="#toc_1.4">MessageConsumer</a>
<li><a href="#toc_1.5">MessageSender</a>
<li><a href="#toc_1.6">配置信息</a>
<li><a href="#toc_1.7">Agent自身的Metrics</a>
</ul>
</ul>
</div>

<h2 id="toc_1.1">Agent总体设计</h2>
<h3 id="toc_1.1.1">功能目标</h3>
<ol>
<li>
提供简便的api,供用户采集结构化数据：log、span(trace)、 metrics

<li>
将采集到的数据按一定的策略发往Collector

</ol>
 
<p>
<img src="logger-agent.png" />
</p>

<h3 id="toc_1.1.2">配置信息</h3>
<p>
<strong>LogConfig:</strong>
</p>
<ul>
<li>
该类代表了环境参数的配置

<li>
使用该agent的appId

<li>
该agent目的地collector的地址和端口

</ul>

<p>
<strong>ConfigManager:</strong>
</p>
<ul>
<li>
该类代表了采集数据的配置

<li>
log级别，是否开启trace等

<li>
单例模式

<li>
自身包含一个timer,会定期从collector刷新配置

</ul>

<p>
<strong>CollectorRegistry &amp; CollectorInfo:</strong>
</p>
<ul>
<li>
类CollectorInfo代表一个Collector实例

<li>
类CollectorRegistry负责初始化并维护Collector实例列表，并提供返回一个CollectorInfo的Api

<li>
目前实际上只有一个Collector实例，是根据LogConfig初始化的

<li>
类CollectorRegistry单例模式

<li>
ConfigManager和MessageSender通过类CollectorRegistry获取Collector实例（即CollectorInfo）

</ul>

<h3 id="toc_1.1.3">数据流 </h3>
<ol>
<li>
ILog ITrace IMetrics负责采集数据，并通过MessageConsumer的api将数据放入一个名为MessageList的队列

<li>
MessageConsumer会跑一个线程，根据条件取出MessageList中的数据并打包成一个Chunk,放入一个名为ChunkQueue的队列

<li>
MessageSender负责从ChunkQueue中取出数据，并发往Collector

</ol>

<h2 id="toc_1.2">结构化数据 </h2>

<h2 id="toc_1.3">Agent数据采集</h2>

<h3 id="toc_1.3.1">采集Log</h3>
<h4 id="toc_1.3.1.1">核心类 </h4>
<ul>
<li>
<strong>LogManager:</strong> 提供静态方法获取一个ILog实例 

<li>
<strong>ILog:</strong> 接口，提供了记录日志的各种api  

<li>
<strong>ILogSender:</strong> 接口，定义了一个send()方法，负责发送日志

</ul>

<h4 id="toc_1.3.1.2">FreewayLogger</h4>
<ul>
<li>
接口ILog的实现

<li>
主要方法writerLog()

<ol>
<li>
负责组装一个LogEvent对象

<li>
将LogEvent作为参数，调用ILogSender的send方法

</ol>
</ul>
     
<h4 id="toc_1.3.1.3">FreewayLoggerSender</h4>
<ul>
<li>
接口ILogSender的实现

<li>
包含一个ITacer的实例

<li>
send()方法的逻辑

<ol>
<li>
接收LogEvent作为参数

<li>
根据ConfigManager判定该LogEvent是否需要记录

<li>
如果需要记录，就将该LogEvent传给ITracer的实例

</ol>
</ul>

<h3 id="toc_1.3.2">采集Trace</h3>
<h3 id="toc_1.3.3">采集Metrics</h3>
<h4 id="toc_1.3.3.1">核心类 </h4>
<ul>
<li>
<strong>MetricManager:</strong> 提供静态方法获取一个IMetric实例 

<li>
<strong>IMetric:</strong> 接口，提供了记录Metrics的各种api  

</ul>

<h4 id="toc_1.3.3.2">IMetricImpl</h4>
<ul>
<li>
接口IMetric的实现

<li>
主要方法writerMetric()

<ol>
<li>
负责组装一个MetricEvent对象

<li>
MetricEvent的 <strong>自定义Tag只能添加4个 </strong> ，超出的会丢弃（总数最多为8个）

<li>
如果需要添加AppIdTag

<li>
如果需要添加HostIpTag

<li>
将MetricEvent传给MessageConsumer

</ol>
</ul>

<h2 id="toc_1.4">MessageConsumer</h2>

<h2 id="toc_1.5">MessageSender</h2>

<h2 id="toc_1.6">配置信息</h2>

<h2 id="toc_1.7">Agent自身的Metrics</h2>

			</div>

			<div id="bottom">
				&copy; 2012 王兴朝
			</div>
		</div>
	<div>
</body>
</html>
